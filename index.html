<html>
	<head>
	</head>
	<body>
		<canvas id="myCanvas" width="800" height="600" style="border:1px solid #000000;"></canvas>

		<script type="text/javascript">
			String.prototype.hashCode = function() {
				var hash = 0, i, chr, len;
				if (this.length == 0) return hash;
				for (i = 0, len = this.length; i < len; i++) {
					chr   = this.charCodeAt(i);
					hash  = ((hash << 5) - hash) + chr;
					hash |= 0; // Convert to 32bit integer
				}
				return hash;
			};

			var Project = function(canvasId) {
				console.log("Init: Project", canvasId);

				if (!canvasId) {
					return;
				}

				this.canvas = document.getElementById(canvasId);

				this.map = new Map(this);
				this.heartBeatsPerSec = 60;
				this.queue = {};
				this.heart;
				this.startHeart();
			};

			Project.prototype.startHeart = function() {
				var delay = Math.floor(1000 / this.heartBeatsPerSec);
				var self = this;
				this.heart = setInterval(function() {
					self.proccessQueue()
				}, delay);
			};

			Project.prototype.proccessQueue = function() {
				var callback;
				for (var i in this.queue) {
					callback = this.queue[i];
					delete this.queue[i];
					if (typeof callback == "function") {
						callback();
					}
				}
			};

			var Map = function(project) {
				console.log("Init: Map");

				this.project      = project;
				this.canvas       = project.canvas;
				this.context      = this.canvas.getContext("2d");
				this.tiles        = {};
				this.tileWidth    = 128;
				this.tileHeight   = 64;
				this.cameraX      = 400;
				this.cameraY      = -300;
				this.dragOffsetX  = 0;
				this.dragOffsetY  = 0;
				this.screenWidth  = 800;
				this.screenHeight = 600;

				this.addEventListeners();
			};

			Map.prototype.draw = function() {
				//console.log("Func: Map::draw", this);

				this.clearCanvas();

				var tile;
				for (var t in this.tiles) {
					tile = this.tiles[t];
					this.drawTile(tile);
				}
			};

			Map.prototype.addEventListeners = function() {
				var self    = this;
				var flag    = 0;
				var element = this.canvas;
				var downX, downY;
				var clickEvent, mouseDownEvent, mouseMoveEvent, mouseUpEvent, mouseOutEvent;

				mouseDownEvent = element.addEventListener("mousedown", function(target){
				    flag = 1;
				    downX = target.clientX;
				    downY = target.clientY;
				}, false);

				mouseUpEvent = element.addEventListener("mouseup", function(target){
					if(flag === 2){
				        self.dragged();
				    } else {
				    	self.clicked(target.clientX, target.clientY);
				    }
				  	flag = 0;
				}, false);

				mouseMoveEvent = element.addEventListener("mousemove", function(target){
					if (flag === 1) {
						if (Math.abs(target.clientX - downX) + Math.abs(target.clientY - downY) >= 5) {
							flag = 2;
							//console.log("stated dragging now!");
						}
					}

					if (flag === 2) {
						self.dragOffsetX = (target.clientX - downX);
						self.dragOffsetY = (target.clientY - downY);
						self.project.queue["drawMap"] = function() {
							self.draw();
						};
					}
				}, false);

				mouseOutEvent = element.addEventListener("mouseout", function(target){
					if(flag === 2){
						self.dragged();
				    }
				  	flag = 0;
				}, false);
			};

			Map.prototype.dragged = function() {
		        this.cameraX += this.dragOffsetX;
		        this.cameraY += this.dragOffsetY;

		        this.dragOffsetX = 0;
		        this.dragOffsetY = 0;	
			};

			Map.prototype.clicked = function(screenX, screenY) {
				screenX -= this.cameraX;
				screenY -= this.cameraY;
				var mapX = Math.floor((screenX / (this.tileWidth / 2) + screenY / (this.tileHeight / 2)) / 2);
				var mapY = Math.floor((screenY / (this.tileHeight / 2) - (screenX / (this.tileWidth / 2))) / 2);
				console.log("Clicked map on tile:", mapX, mapY);
			};

			Map.prototype.addTile = function(tile) {
				//console.log("Func: Map::addTile");

				this.tiles[(tile.x + ":" + tile.y).hashCode()] = tile;
			};

			Map.prototype.clearCanvas = function() {
				this.context.clearRect(0, 0, this.screenWidth, this.screenHeight);
			};

			Map.prototype.drawTile = function(tile) {
				//console.log("Func: Map::drawTile", tile);

				var screenX = ((tile.x - tile.y) * (this.tileWidth / 2)) + this.cameraX + this.dragOffsetX;
				var screenY = ((tile.x + tile.y) * (this.tileHeight / 2)) + this.cameraY + this.dragOffsetY;

				if (screenX < (0 - (this.tileWidth * 2)) ||
					screenX >= (this.screenWidth + (this.tileWidth * 2)) ||
					screenY < (0 - (this.tileHeight * 2)) ||
					screenY >= (this.screenHeight + (this.tileHeight * 2))) {
					return;
				}

				this.context.fillStyle = tile.attr.color; //'#f00'; //#'+Math.floor(Math.random()*16777215).toString(16);;
				this.context.beginPath();
				this.context.moveTo(screenX, screenY);
				this.context.lineTo(screenX + (this.tileWidth / 2), screenY + (this.tileHeight / 2));
				this.context.lineTo(screenX, screenY + this.tileHeight);
				this.context.lineTo(screenX - (this.tileWidth / 2), screenY + (this.tileHeight / 2));
				this.context.closePath();
				this.context.fill();
				this.context.stroke();
				this.context.font = "8px Arial";
				this.context.fillStyle = "#000";
				this.context.textAlign = "center";
				this.context.fillText("("+tile.x+","+tile.y+")", screenX, screenY+10);
			};

			Map.prototype.generateRegion = function(regionX, regionY) {
				var regionSize = 19;

				// Create Tiles
				var maxX = regionSize * (regionX + 1);
				var maxY = regionSize * (regionY + 1);

				for (var i = regionSize * regionX; i < maxX; i++) {
					for (var j = regionSize * regionY; j < maxY; j++) {
						this.addTile(new Tile(i,j,{color:'#070'}));
					}
				}

				// Seed edge tile with dirt patch
				var seed = this.tiles[("0:8").hashCode()];
				console.log("Got me a seed tile", seed);

				seed.set("color", "#994A40");
				seed.set("trailStart", true);

				// Determine state of edge tiles
				
				// Start simple and create dirt trail (Drunkard Walk)
				// 1 Find trail start
				// 2 Pick a valid random direction
				// 3 Make new dirt patch
				// 4 Repeat 2 and 3 until edge of region
			};

			var Tile = function (x, y, data) {
				console.log("Init: Tile", x, y, data);

				this.x    = x;
				this.y    = y;
				this.attr = data;
			};

			Tile.prototype.set = function(key, value) {
				this.attr[key] = value;
			};

			Tile.prototype.get = function(key) {
				return this.attr[key];
			};

			var myProject = new Project("myCanvas");

			myProject.map.generateRegion(0,0);

			myProject.map.draw();
		</script>
	</body>
</html>
